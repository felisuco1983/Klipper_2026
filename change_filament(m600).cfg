[gcode_macro PAUSE]
description: Modified pause macro
rename_existing: BASE_PAUSE
# change this if you need more or less extrusion
variable_extrude: 1.0
gcode:
    ##### read E from pause macro #####
    {% set E = printer["gcode_macro PAUSE"].extrude|float %}
    ##### set park positon for x and y #####
    # default is your min posion from your printer.cfg
    {% set x_park = printer.toolhead.axis_minimum.x|float + 5.0 %}
    {% set y_park = printer.toolhead.axis_minimum.y|float + 5.0 %}
    ##### calculate safe lift position #####
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set act_z = printer.toolhead.position.z|float %}
    {% if act_z > (max_z - 20.0) %}
        {% set z_safe = max_z %}
    {% else %}
        {% set z_safe = (act_z + 20.0) %}
    {% endif %}
    ##### end of definitions #####
    SAVE_GCODE_STATE NAME=PAUSE_state
    BASE_PAUSE
    G91
    G1 E-{E} F2100
    G1 Z{z_safe} F900
    G90
    G1 X{x_park} Y{y_park} F3000
    M300

[gcode_macro RESUME]
description: modified pause macro
rename_existing: BASE_RESUME
gcode:
    ##### read E from pause macro #####
    {% set E = printer["gcode_macro PAUSE"].extrude|float %}
    ##### end of definitions #####
    G91
    G1 E{E} F2100
    RESTORE_GCODE_STATE NAME=PAUSE_state

    BASE_RESUME

 
################################################################################
################################################################################

######################################################################
#                           CAMBIAR FILAMENTO
######################################################################
#   M600
#   M601
#   CHANGE_FILAMENT
#   LOAD_FILAMENT
#   UNLOAD_FILAMENT
######################################################################

[gcode_macro M600]
gcode:  
   CHANGE_FILAMENT

[gcode_macro M601]
gcode:
   PAUSE
   
[gcode_macro CHANGE_FILAMENT]
gcode:
    PAUSE
    UNLOAD_FILAMENT
	
[gcode_macro LOAD_FILAMENT]
gcode: |
    #{% if (not(printer.idle_timeout.state == "Printing") or printer.pause_resume.is_paused) %}
    {% if printer.extruder.can_extrude|lower == 'true' %}
        SAVE_GCODE_STATE NAME=LOAD_state
        NOTIFY TEXT="Cargando filamento..."
        M83                            ; set extruder to relative
        G1 E80 F300                    ; load 
        G1 E-0.4 F300                  ; short retract
        NOTIFY TEXT="Filamento cargado..." CLEAR=1
        RESTORE_GCODE_STATE NAME=LOAD_state
   {% else %}
      NOTIFY TEXT="Temperatura baja, imposible cargar el filamento."
   {% endif %}

[gcode_macro UNLOAD_FILAMENT]
gcode:
    #{% if (not(printer.idle_timeout.state == "Printing") or printer.pause_resume.is_paused) %}
    {% if printer.extruder.can_extrude|lower == 'true' %}
        SAVE_GCODE_STATE NAME=UNLOAD_state

        M83                            ; set extruder to relative
        G1 E20 F450                    ; quick purge
        G1 E-5 F1800                   ; fast retract
        G1 E-100 F1200                 ; fast retract all filament
        NOTIFY TEXT="Extraer filamento." CLEAR=1
        RESTORE_GCODE_STATE NAME=UNLOAD_state
    {% else %}
        NOTIFY TEXT="Temperatura baja, imposible retraer el filamento."
    {% endif %}


[gcode_macro NOTIFY]
description: Envia un texto al LCD y Consola. Uso: NOTIFY TEXT="TEXTO" CONSOLE=[1|0] No envia texto a la consola CLEAR=[0|1] limpia pantalla en x(10) segundos. DURATION= segundos espera limpiar pantalla 
gcode:
    {% set TEXT = params.TEXT|default("")|string %}
    {% set DURATION = params.DURATION|default(10)|int %}
    {% set CONSOLE = params.CONSOLE|default(1)|int %}
    {% set CLEAR = params.CLEAR|default(0)|int %}
    
    {% if TEXT != "" %}
        M117 {TEXT}
        {% if CONSOLE|int == 1 %}
            {action_respond_info("%s" % (TEXT))}
        {% endif %}

        {% if CLEAR|int == 1 %}
            UPDATE_DELAYED_GCODE ID=CLEAR_DISPLAY DURATION={DURATION}
        {% endif %}
    {% endif %}

[delayed_gcode CLEAR_DISPLAY]
gcode:   
  M117

################################################################################
################################################################################

[gcode_macro DISABLE_STEPPERS]
gcode: 
  M84 ; Disable motors

################################################################################
################################################################################

[gcode_macro NIVEL_ESQUINAS]
gcode: 
  BED_SCREWS_ADJUST

[gcode_macro ACEPTAR]
gcode: 
  ACCEPT

[gcode_macro AJUSTAR]
gcode: 
  ADJUSTED

[gcode_macro ABORTAR]
gcode: 
  ABORT

##########################################################################
##########################################################################

[gcode_macro Z_TILT_ADJ]
gcode:
  Z_TILT_ADJUST 

##########################################################################
##########################################################################

[gcode_macro SCREWS_TILT_CALC]
gcode:
   SCREWS_TILT_CALCULATE 


########################################################################
########################################################################

[gcode_macro PID_BED]
gcode:
    M106
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=200
    PID_CALIBRATE HEATER=heater_bed TARGET=60
    M104 S0 ; turn off temperature
    M107 ; turn off fan

[gcode_macro PID_NOZZLE]
gcode:
    M106
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=60
    PID_CALIBRATE HEATER=extruder TARGET=200
    M140 S0 ; turn off heatbed
    M107 ; turn off fan

#######################################################################
#######################################################################

[gcode_macro M300]
gcode:
    {% set S = params.S|default(2000)|int %} # Por defecto 1 kHz (Frecuencia)
    {% set P = params.P|default(500)|int %} # Por defecto 100 ms (Duraci√≥n)
    SET_PIN PIN=beeper VALUE={S}
    G4 P{P}
    SET_PIN PIN=beeper VALUE=0

